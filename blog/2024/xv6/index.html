<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Xv6 | Yuyang Tang </title> <meta name="author" content="Yuyang Tang"> <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. "> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://tyy-x.github.io/blog/2024/xv6/"> <script src="/assets/js/theme.js?a5ca4084d3b81624bcfa01156dae2b8e"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Yuyang</span> Tang </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Xv6</h1> <p class="post-meta"> Created in April 26, 2024 by TYY </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/xv6"> <i class="fa-solid fa-hashtag fa-sm"></i> xv6</a>   <a href="/blog/tag/os"> <i class="fa-solid fa-hashtag fa-sm"></i> OS</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <p>This post marks the starting point of my journey into the world of operating systems by examining a particular one called <a href="https://github.com/mit-pdos/xv6-public" rel="external nofollow noopener" target="_blank">xv6</a>.</p> <p>Xv6 is a teaching operating system developed by the people in MIT. There are two official versions of xv6. It is first developed targeting the x86 architecture, later their effort moves to the development for the new RISC-V architecture. And the original x86 version is no longer under development.</p> <p>I chose the x86 version simply because I want to know more about the x86 architecture.</p> <h2 id="environment-to-build-and-run-the-kernel">Environment to build and run the kernel</h2> <p>I have a Debian 12 system set up on my old Macbook Pro which uses an Intel CPU (Core i5-6287U, dual cores, 4 threads). To build and/or debug the kernel, a compiler toolchain and various other tools (such as <strong>Make, GDB</strong>) are needed. To run the kernel, I need <a href="https://www.qemu.org/docs/master/about/index.html" rel="external nofollow noopener" target="_blank">QEMU</a>. QEMU is a machine emulator which can be used for system emulation and user mode emulation. System emulation provides a virtual model of an entire machine (CPU, memory and emulated devices) to run a guest OS. Obviously, this is what I need. To install QEMU on Debian, just run this command:</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>qemu-system-x86
</code></pre></div></div> <p>Now I describe the steps to build and run the kernel.</p> <h3 id="get-the-source-code">Get the source code</h3> <p>I cloned the original repo of xv6 as xv6-x86 to my local machine:</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/clone-480.webp 480w,/assets/img/clone-800.webp 800w,/assets/img/clone-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/clone.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h2 id="build">Build</h2> <p>Now, it’s time to build the kernel. Run <code class="language-plaintext highlighter-rouge">make</code> inside the root directory of the cloned repository:</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/build-480.webp 480w,/assets/img/build-800.webp 800w,/assets/img/build-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/build.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>You can see that there is something wrong in the source file <strong>mp.c</strong> that causes gcc to report errors. Of course the permanent solution is to fix those problems (which look like bugs based on the error descriptions), but now I just want to make sure that the kernel is runable. So the workaround here is to modify the flags passed to gcc. Take a look at the <strong>Makefile</strong>, you can see that the option <code class="language-plaintext highlighter-rouge">-Werror</code> is passed to gcc, so gcc will make all warnings into errors.</p> <div class="language-make highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">CFLAGS</span> <span class="o">=</span> <span class="nt">-fno-pic</span> <span class="nt">-static</span> <span class="nt">-fno-builtin</span> <span class="nt">-fno-strict-aliasing</span> <span class="nt">-O2</span> <span class="nt">-Wall</span> <span class="nt">-MD</span> <span class="nt">-ggdb</span> <span class="nt">-m32</span> <span class="nt">-Werror</span> <span class="nt">-fno-omit-frame-pointer</span>
</code></pre></div></div> <p>Just delete the <code class="language-plaintext highlighter-rouge">-Werror</code> option then Make will run quietly:</p> <div class="language-make highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># CFLAGS = -fno-pic -static -fno-builtin -fno-strict-aliasing -O2 -Wall -MD -ggdb -m32 -Werror -fno-omit-frame-pointer
</span><span class="nv">CFLAGS</span> <span class="o">=</span> <span class="nt">-fno-pic</span> <span class="nt">-static</span> <span class="nt">-fno-builtin</span> <span class="nt">-fno-strict-aliasing</span> <span class="nt">-O2</span> <span class="nt">-Wall</span> <span class="nt">-MD</span> <span class="nt">-ggdb</span> <span class="nt">-m32</span> <span class="nt">-fno-omit-frame-pointer</span>
</code></pre></div></div> <h2 id="run-the-kernel">Run the kernel</h2> <p>To run the kernel inside qemu, just run the command <code class="language-plaintext highlighter-rouge">make qemu</code>:</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/qemu-480.webp 480w,/assets/img/qemu-800.webp 800w,/assets/img/qemu-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/qemu.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Wonderful! Despite the problems in the source code, xv6 boots and runs inside qemu. Now let’s try some shell commands.</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/commands-480.webp 480w,/assets/img/commands-800.webp 800w,/assets/img/commands-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/commands.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>The <code class="language-plaintext highlighter-rouge">ls</code> and <code class="language-plaintext highlighter-rouge">echo</code> commands run perfectly! How very exciting!</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2015/images/">a post with images</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/pc-in-arm/">Program Counter in ARM Processor</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/advanced-images/">a post with advanced image components</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2021/distill/">a distill-style blog post</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/videos/">a post with videos</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Yuyang Tang. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?b7816bd189846d29eded8745f9c4cf77"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.min.js"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>